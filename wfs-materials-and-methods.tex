% !TEX root = widefieldscan.tex
\svnidlong
{$HeadURL$}
{$LastChangedDate$}
{$LastChangedRevision$}
{$LastChangedBy$}
%
\section{Materials and Methods}
\label{sec:materials and methods}
\subsection{Sample Preparation}
Rat lung samples, prepared according to
\ifhtml
	\citet{Tschanz2002} and \citet{Luyet2002}
\else
	\citeasnoun{Tschanz2002} and \citeasnoun{Luyet2002}
\fi
were used as test objects. Briefly, lungs of Sprague-Dawley rats were filled with \SI{2.5}{\percent} glutaraldehyde (\cf{CH2(CH2CHO)2}) in \SI{0.03}{\Molar} potassium-phosphate buffer (pH 7.4) by instillation via tracheotomy at a constant pressure of \SI{20}{\centi\meter} water column. In order to prevent recoiling of the lung, the pressure was maintained during glutaraldehyde-fixation for a minimum of \SI{2}{\hour}. Subsequently, the lungs were dissected free and immersed in toto in the same fixative at a temperature of \SI{4}{\celsius} for at least \SI{24}{\hour}.

The samples were postfixed with \SI{1}{\percent} osmium tetroxide (\cf{OsO4}) and stained with \SI{4}{\percent} uranyl nitrate (\cf{UO2(NO3)2}) to increase the x-ray absorption contrast, dehydrated in a graded series of ethanol and embedded in paraffin using Histoclear (Merck KGaA, Darmstadt, Germany) as an intermedium. The lung samples were mounted onto standard scanning electron microscopy sample holders (PLANO GmbH, Wetzlar, Germany) using paraffin.

The handling of animals before and during the experiments, as well as the experiments themselves, were approved and supervised by the Swiss Agency for the Environment, Forests and Landscape and the Veterinary Service of the Canton of Bern, Switzerland.

\subsection{Synchrotron radiation tomographic microscopy}
The experiments were performed on the TOMCAT beamline~\cite{Stampanoni2006a} at the Swiss Light Source, Paul Scherrer Institut, Villigen, Switzerland. \cbdelete

The samples were scanned at \SI{12.6}{\kilo\electronvolt}\cbdelete. After penetration through the sample, the x-rays were converted into visible light by a YAG:Ce scintillator (\SI{18}{\micro\meter} thickness, Crismatec Saint-Gobain, Nemours, France). The projection images were magnified by diffraction limited microscope optics (10$\times$ magnification) and digitized by a high-resolution 2048$\times$2048 pixel CCD camera (pco.2000, PCO AG, Kelheim, Germany) with 14 bit dynamic range. \cbstart The detector was operated in 2$\times$2 binning mode, as a result, the pixel size was \SI{1.48}{\micro\meter} and the exposure time was \SI{175}{\milli\second}.\cbend

Projection images $I_{Pr}$, were recorded at equiangular positions between \SI{0}{\degree} and \SI{180}{\degree}. The exact number of angular projections depended on the selected scan protocol, as described in section~\ref{subsec:quality-guided-protocols}. Additionally, a set of dark ($I_{D}$) and flat images ($I_{F}$) were recorded for each protocol \cbstart for noise and baseline correction. \cbend\cbdelete Further details can be found in 
\ifhtml
	\citet{Hintermueller2009}
\else
	\citeasnoun{Hintermueller2009}
\fi%
.

\subsection{Wide field scanning}
For parallel beam geometry, tomographic images are obtained at equidistant angles over a sample rotation of \SI{180}{\degree} as shown in Figure~\ref{fig:scanning-possibilities}(a). After reconstruction, the width of the image corresponds to the field of view of the camera.

Samples which are twice as large as the field of view can be imaged using scanning protocols based on a \SI{360}{\degree} off center sample rotation as shown in Figure~\ref{fig:scanning-possibilities}(b). Images recorded between \SI{180}{\degree} and \SI{360}{\degree} have to be flipped after acquisition: the projections obtained at angular position $\theta$ and $\theta$+\SI{180}{\degree} ($I_{Pr_{\theta}}$ and $I_{Pr_{\theta+\SI{180}{\degree}}}$) are stitched together. The resulting images cover twice the field of view of the camera.

\begin{figure}
	\centering
	\caption{Covering the field of view of differently sized samples with one \SI{180}{\degree} scan (a), one \SI{360}{\degree} scan (b) or---in the case of the so called wide field scanning---with multiple subscans (three subscans, c). The filled segments mark the region of the sample that is covered while scanning the respective positions (Position 1: magenta/checkerboard, Position 2: yellow, Position 3: cyan/striped).}%
	\ifiucr		
		\input{tikz-images/scanning-possibilities}%
	\else
	\fi
	\label{fig:scanning-possibilities}%
\end{figure}

For tomographic scans covering a size wider than twice the field of view, three or more \SI{180}{\degree}-scans taken at slightly overlapping positions have to be combined, as shown Figure~\ref{fig:scanning-possibilities}(c). The projection images of each subscan overlap slightly to \cbstart facilitate the stitching of multiple projections into a single one. The cutline, \ie the position where the merging takes place, is automatically determined according to a mean squared difference method.\cbend

The discussed scanning protocol for covering a wide field of view with three subscans is based on the assumption that a sufficient resolution and contrast can be achieved in the tomographic dataset, if the sampling theorem is individually fulfilled for each of the subscans. This results in a set of $i$ subscans with $P_{i}$ projection images. A simple example with $P_{1}=4$ and $P_{2}=P_{3}=8$ is shown in Figure~\ref{fig:projections}(a).

\cbdelete Since each subscan has a different number of projections $P_{i}$, the stitching algorithm has to interpolate projections from adjacent projections (represented by the black dotted lines in Figure~\ref{fig:projections}(b)).\cbdelete

\begin{figure}
	\centering
	\caption{Setup with three \SI{180}{\degree} scans; one central (yellow) and two lateral (magenta and cyan, respectively). In this drawing, four projections for the central and eight projections for each of the lateral scans have been chosen. The colors of the three positions correspond to the colors shown in Figure~\ref{fig:scanning-possibilities}(c). Panel a): scanned projections, panel b): scanned projections and additional interpolated projections (dotted) required to merge all projections.}
	\ifiucr
		\input{tikz-images/ProjectionSetup}%
		\input{tikz-images/ProjectionSetupInterpolate}
	\else
	\fi
	\label{fig:projections}
\end{figure}

\subsubsection{Reduction of acquisition time and radiation dose}
\label{subsubsec:reduction-of-acquisition-time}
\cbstart Obviously, the total acquisition time per sample linearly scales with the total amount of recorded projections for all subscans. If we record an equal amount of projections for each of the subscans to avoid interpolation, we oversample the central part of the sample. This increases the total amount of beam time for one sample without increasing the quality of the reconstructed tomographic data. Thus, oversampling is generally avoided.\cbend Our goal was to find a good compromise between scanning time and image quality.
\cbstart 
Different acquisition protocols with varying number of projections for each of the subscans have been defined (details are specified in Table~\ref{tab:protocols}). Optimizing the individual number of projections acquired per subscans decreases the total acquisition time for one sample and thus the imparted radiation dose.
\cbend

To simplify interpolation and merging of the projections from each subscan, thus avoiding oversampling the central part, we selected acquisition schemes where the fraction of the amount of projections of the inner ($P_{inner}$) to the outer subscans ($P_{outer}$) is always a multiple of two (see figure~\ref{fig:projections})
.\cbdelete

\cbstart We defined a gold standard as well as several scanning protocols in order to compare different acquisition schemes. The \cbend gold standard protocol covers the desired field of view fulfilling the sampling theorem in its regions, as shown in Figure~\ref{fig:SubScan-Setup}(a). \cbdelete\cbstart In this case we need to achieve a field of view of 3072 pixels. The dark gray circle is the field of view that could be covered using a detector with a diameter of 3072 pixels.\cbend

Using a detector with a size of 1024 pixels, this desired field of view could be covered with nine independent scans. Such an approach would require nine independent reconstructions and stitching of those nine tomographic datasets into one dataset covering the full field of view. Stitching 9 smaller reconstructions like this would also introduce artifacts from the reconstruction algorithm (contained in the light gray parts filling the room between the square and the circle) which would lie inside the sample to be imaged.

While the chosen field of view of 3072$\times$3072 pixels can be covered using a detector of the size of 3072 pixels in one scan, we can cover the desired field of view with a much smaller detector, using a scanning protocol with three subscans from which we obtain merged projections. Figure~\ref{fig:SubScan-Setup}(b) shows how the desired field of view of 3072 pixels can be covered with a wide-field scan, composed of one central and two half ring-scans, recorded with a detector with a size of 1024 pixels. A further increase in the field of view can be obtained by simple iteration. Figures~\ref{fig:SubScan-Setup}(c)--(f) show such a setup for a five- or seven-fold increase.

\begin{figure}
	\centering
	\caption{Setup for different field of views. %
		(a) Desired field of view of 3072 pixel diameter. %
		(b) Gold standard scanning protocol for covering the desired field of view of panel (a) with merged projections from one central and two half ring scans ($r_{1}$ and $r_{2}$). %
		(c) Desired field of view of 5120 pixel diameter. %
		(d) Gold standard scanning protocol for covering the desired field of view of panel (c) with merged projections from one central and four half ring scans ($r_{1}$--$r_{4}$). %
		(e) Desired field of view of 7168 pixel diameter. %
		(f) Gold standard scanning protocol for covering the desired field of view of panel (e) with merged projections from one central and six half ring scans ($r_{1}$--$r_{6}$).}%
	\ifiucr		
		\input{tikz-images/SubScanSetup/SetupFor-3-5-7-SubScans}
	\else
	\fi
	\label{fig:SubScan-Setup}
\end{figure}

\subsection{Wide Field Scanning Pipeline}
\label{subsec:wfs-setup}
A MATLAB-script (MATLAB\textsuperscript{\textregistered} 7.6.0.324 (R2008a), The MathWorks, Inc.) reads several parameters like desired field of view, detector width, magnification and binning and calculates the number of projections needed to satisfy the sampling theorem for the chosen field of view. This gold-standard protocol is used to compute a set of acquisition protocols with reduced amount of projections.

Using a Shepp-Logan phantom~\cite{Shepp1974} as \cbstart a gold standard reference \cbend image, a simulated scan and subsequent reconstruction is calculated for each protocol of this set. The expected reconstruction quality is calculated, \cbstart using the difference image between such the reconstruction of such a simulated scan \cbend and the gold standard\cbdelete. The calculated reconstruction quality is then plotted against the acquisition time, which enables the user to chose a suitable protocol balancing expected image quality and acquisition time.

After the user has chosen a suitable protocol out of the presented set, a file containing the details of the scan is written to disk. This file contains the parameters needed to scan this protocol: the number of required subscans, the positions of the sample, the number of projections and the start and stop angles of the rotation for each subscan. A custom Python-script (\url{http://python.org/}) parses the file containing the details and interacts with the EPICS-System (Experimental Physics and Industrial Control System, Argonne National Laboratory, Argonne, USA, \url{http://www.aps.anl.gov/epics/}), which itself is used to control the hardware of the TOMCAT beamline, enabling an automated, unattended batch scan of all the desired subscans.

After the multiple subscans have been recorded, the stitching of the projections recorded per subscans into projections covering the desired field of view is performed with minimal user interaction using a second MATLAB-script. Further processing of the merged projections such as sinogram generation and reconstruction into the tomographic dataset are integrated into the TOMCAT data-processing pipeline, as specified by
\ifhtml
	\citet{Hintermueller2009}%
\else
	\citeasnoun{Hintermueller2009}%
\fi%
.

\subsection{Batch Acquisition of the Protocols}
Multiple scanning protocols were defined in a way that the total amount of recorded projections for the different protocols were linearly scaled down compared to a gold standard scan \cbstart (A) In total we scanned 19 different protocols (B--T), which are described in detail in section \cbend section~\ref{subsec:quality-guided-protocols}). All parameters of each protocol, such as sample-position in relation to the beam, rotation angles and amount of projections to obtain for each of the individual subscans were set in a preference-file, generated using the aforementioned MATLAB-script. All protocols \cbdelete were scanned as a batch scan without manual intervention, permitting a direct comparison of the reconstructed datasets only limited by the repositioning inaccuracies of the TOMCAT beamline.

After acquisition of the three subscans per protocol, custom MATLAB functions read the parameters of the single subscans (\eg sample name, amount of subscans, amount of dark and flat images) as well as the desired output-name and -suffix, and performed all necessary calculations, including: loading of the correct projections from each subscan; normalizing; interpolation; cutline detection; correct stitching of the images into wide field projections, and writing these merged projections to disk.

The merged projections were rearranged into sinograms, where the $n$\textsuperscript{th} sinogram is composed of the $n$\textsuperscript{th} line of every corrected projection. The $n$\textsuperscript{th} slice of the tomographic scan was reconstructed from the $n$\textsuperscript{th} sinogram using an FFT-based regridding algorithm~\cite{Dowd1999}. The 19 tomographic datasets were reconstructed on a 20-node server farm composed of five \SI{64}{\bit} Opteron machines with 4 cores and \SI{8}{\giga\byte} RAM each. The reconstructions resulted in an image stack covering a large sample volume of 2793$\times$2793$\times$1024 pixels, a nine-fold increase from the standard volume of 1024$\times$1024$\times$1024 pixels for one conventional scan.