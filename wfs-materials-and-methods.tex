%!TEX root = widefieldscan.tex
\svnidlong
{$HeadURL$}
{$LastChangedDate$}
{$LastChangedRevision$}
{$LastChangedBy$}

\ifhtml
\else
\begin{center}
	\fbox{
		\begin{minipage}{.618\columnwidth}
		The section below is versioned at \url{\svnkw{HeadURL}} (last commit @ \svnfileday.\svnfilemonth.\svnfileyear \space \svnfilehour:\svnfileminute, Revision: \svnkw{LastChangedRevision}).
		\end{minipage}
	} 
\end{center}
\fi

\section{Materials and Methods}%
\label{sec:materials and methods}%
\subsection{Sample Preparation and Image Acquisition}%
Rat lung samples, prepared according to %
\ifhtml
	\citet{Tschanz2002} and \citet{Schittny1997}
\else
	\citeasnoun{Schittny1997} and \citeasnoun{Tschanz2002}
\fi%
were used as test objects. Briefly, lungs of Sprague-Dawley rats have been filled with \SI{2.5}{\percent} glutaraldehyde (C$_5$H$_8$O$_2$) in \SI{0.03}{\Molar} potassium-phosphate buffer (pH 7.4) by instillation via tracheotomy at a constant pressure of \SI{20}{\centi\meter} water column. In order to prevent a recoiling of the lung, the pressure was maintained during fixation (minimum of \SI{2}{\hour}). Subsequently, the lungs were dissected free and immersed in toto in the same fixative for at least \SI{24}{\hour} at a temperature of \SI{4}{\celsius}.

The samples were postfixed with \SI{1}{\percent} osmium tetroxide (OsO$_4$) and stained with \SI{4}{\percent} uranyl acetate (C$_4$H$_6$O$_6$U), dehydrated in a graded series of ethanol and embedded in paraffin using Histoclear (Merck KGaA, Darmstadt, Germany) as an intermedium. The lung samples were mounted onto standard electron microscopy sample holders (PLANO GmbH, Wetzlar, Germany) using paraffin.

Handling of the animals before and during the experiments, as well as the experiments themselves, were approved and supervised by the Swiss Agency for the Environment, Forests and Landscape and the Veterinary Service of the Canton of Bern.

\subsection{SRXTM}%
All experiments were performed at the TOMCAT beamline~\cite{Stampanoni2006a}, Swiss Light Source, Paul Scherrer Institut, Villigen, Switzerland. TOMCAT receives photons from a \SI{2.9}{\tesla} super-bending magnet. The critical energy of this super-bending magnet is \SI{11.1}{\kilo\electronvolt} (corresponding to a wavelength of \SI{1.22}{\angstrom}). A double crystal multilayer monochromator covers an energy range between 6 and \SI{45}{\kilo\electronvolt} with a bandwidth range of a few percent to a few permille.

\subsubsection{Image acquisition and reconstruction}%
\label{seq:Image Acquisition}%
The samples have been scanned at an x-ray energy of \SI{12.6}{\kilo\electronvolt}. After penetration of the sample, the x-rays are converted into visible light by a YAG:Ce scintillator (\SI{18}{\micro\meter} thickness, Crismatec Saint-Gobain, Nemours, France). The projection images were further magnified by diffraction limited microscope optics and digitized by a high-resolution 2048$\times$2048 pixel CCD camera (pco.2000, PCO AG, Kelheim, Germany) with 14 bit dynamic range. The lung samples were imaged using a 10$\times$ magnification, with 2$\times$2 binning and \SI{175}{\milli\second} exposure time resulting in isotropic voxels with a side length of \SI{1.48}{\micro\meter}.

Projection images $I_{Pr}$---essentially single radiographies---of the samples have been recorded at several angular positions between \SI{0}{\degree} and \SI{180}{\degree}. The exact number of angular projections depends on the selected scan protocol. Additionally, a set of dark ($I_{D}$) and flat images ($I_{F}$) are recorded for each protocol. The dark images $I_{D}$ were recorded at the start of the scan to capture the noise and dark current of the camera. The flat images $I_{F}$ recorded at the start and at the end of the scan capture the beam profile.

Corrected projection images $I_{cPr}$ have been obtained by correcting $I_{Pr}$ with the average dark ($\overline{I_{D}}$) and average flat image ($\overline{I_{F}}$) using the Beer-Lambert law (see below) and relation described in equation~\ref{eq:cpr}.

The Beer--Lambert law relates the absorption of electromagnetic waves to the properties of the material through which these waves are traveling. Let $I_{0}$ and $I_{1}$ be the intensity of the incident electromagnetic wave and the intensity after penetration of the material, respectively. If $\alpha$ describes the absorption coefficient of the substance and $l$ the path length the wave travels through the material, then the intensity of the transmitted wave can be calculated using the Beer--Lambert law: \(I_{1}=I_{0}e^{-\alpha l}\label{eq:beer-lambert}\).

The inversion of the Beer--Lambert law was used to calculate the corrected projection images $I_{cPr}$:
\begin{equation}
	I_{cPr} = -ln\left(\frac{I_{Pr}-\overline{I_{D}}}{\overline{I_{F}}-\overline{I_{D}}}\right)
	= ln(\overline{I_{F}}-\overline{I_{D}})-ln(I_{Pr}-\overline{I_{D}})
	\label{eq:cpr}
\end{equation}

A detailed description of the workflow at TOMCAT and the steps necessary to compute a tomographic data set from a set of angular projections can be found in%
\ifhtml
	~\citet{Hintermueller2009}
\else
	~\citeasnoun{Hintermueller2009}
\fi%
.

\subsubsection{Covering a wide field of view perpendicular to the rotational axis}%
For parallel beam geometry, tomographic images are obtained at equidistant angles over a sample rotation of \SI{180}{\degree} as shown in figure~\ref{fig:scanning-possibilities}a). After reconstruction the width of the image corresponds to the field of view of the camera.

Samples which are twice as large as the field of view can be imaged using scanning protocols based on a \SI{360}{\degree} off-centre sample rotation as shown in figure~\ref{fig:scanning-possibilities}b). Images recorded between \SI{180}{\degree} and \SI{360}{\degree} have to be flipped after acquisition and the projection images obtained at position $I_{x}$ and $I_{x+\SI{180}{\degree}}$ are stitched together to projection images covering two times the field of view of the camera.

\ifiucr
	%\onecolumn
	\begin{figure}
		\centering
		\caption{Covering the field of view of differently sized samples with one \SI{180}{\degree} scan (a), one \SI{360}{\degree} scan (b) or---in the case of the so called wide field scanning---with multiple subscans (three subscans, c). The filled segments mark the region of the sample which is covered while scanning the respective positions (Position 1: red/checkerboard, Position 2: green, Position 3: blue/striped).}%
		\input{tikz-images/scanning-possibilities}%
		\label{fig:scanning-possibilities}%
	\end{figure}
	%\twocolumn
\else
	\begin{figure}
		\input{tikz-images/scanning-possibilities}%
		\label{subfig:scanning-possibilities}%
		\caption{Covering the field of view of differently sized samples with one \SI{180}{\degree} scan (a), one \SI{360}{\degree} scan (b) or---in the case of the so called wide field scanning---with multiple subscans (three subscans, c). The filled segments mark the region of the sample which is covered while scanning the respective positions (Position 1: red/checkerboard, Position 2: green, Position 3: blue/striped).}%
		\label{fig:scanning-possibilities}%
	\end{figure}
\fi

If we would like to achieve tomographic scans covering a size wider than two field of views, we have to combine three or more \SI{180}{\degree} scans taken at slightly overlapping positions as shown figure~\ref{fig:scanning-possibilities}c).

The projection images of each subscan have to overlap by 20-100 pixels to allow an optimal stitching of the multiple projections of each rotational angle into one projection. Using the mean squared difference between adjacent subscan images~\cite{Hintermueller2009}, such a cutline has been calculated for all the adjacent subscans of every scanned protocol and used to merge the single projections into projections covering the full field of view.

\subsection{Generation of multiple scanning protocols}%
The discussed scanning protocol for covering a wide field of view with three subscans is based on the assumption that a sufficient resolution and contrast can be achieved in the tomographic data sets when the sampling theorem is fulfilled for each of the three subscans individually. This results in a set of scans with $P_{i}$ projection images. A simple example with $P_{1}=4$ and $P_{2}=P_{3}=8$ is shown in figure~\ref{fig:projections}a).

To be able to reconstruct the sample, we need to stitch the individual sets of projections to projections spanning the desired field of view. Since each scan has a different number of projections $P_{i}$, a stitching algorithm has to interpolate projections from adjacent projections (as shown in figure~\ref{fig:projections}b)). Alternatively, the same number of projections has to be acquired for all subscans, leading to oversampling for the central scanning position.

\ifiucr
	\begin{figure}%
		\caption{Setup with three \SI{180}{\degree} scans; one central (green) and two lateral (red and blue, respectively). In this drawing, we chose four projections for the central and eight projections for each of the lateral scans. The colors of the three positions correspond to the colors shown in figure~\ref{fig:scanning-possibilities}c). Panel a): scanned projections, panel b): scanned projections and additional interpolated projections (dashed) needed to correctly merge all projections.}%
		\begin{tabular}{cc}%
			\input{tikz-images/ProjectionSetup}%
		&%
			\input{tikz-images/ProjectionSetupInterpolate}%
		\\%
		a) & b)\\%
		\end{tabular}%
		\label{fig:projections}%
	\end{figure}%
\else
	\begin{figure*}[htp]
		\centering
		\subfloat[]{%
			\input{tikz-images/ProjectionSetup}%
			\label{subfig:ProjectionSetup}%
			}%
		\subfloat[]{%
			\input{tikz-images/ProjectionSetupInterpolate}%
			\label{subfig:ProjectionSetupInterpolate}%
			}%
	%	\caption[Setup with one central and two lateral scans]
		\caption{Setup with one central (green) and two lateral scans (red and blue, respectively). For demonstration purposes, the central scan has four projections and the lateral scans have eight projections each (all acquired over \SI{180}{\degree}). The colors of the three positions correspond to the colors shown in figure~\ref{subfig:scanning-possibilities}. \subref{subfig:ProjectionSetup}: scanned projections, \subref{subfig:ProjectionSetupInterpolate}: scanned projections and additional interpolated projections (dashed) needed to correctly merge all projections.}
		\label{fig:projections}
	\end{figure*}
\fi

\subsubsection{Reduction of the acquisition time}%
Since the total acquisition time per sample linearly scales with the total amount of projections of the three subscans, we tend to avoid oversampling to reduce the total amount of beam time used for one sample. Our goal was to find a good compromise between scanning and processing time and image quality. In order to reduce the time required for scanning one sample, acquisition protocols with varying amount of projections for each of the three subscans have been designed.

To simplify the interpolation and merging of the projections from each subscan, we selected protocols where the amount of projections from the inner ($P_{inner}$) to the outer subscans ($P_{outer}$) is always a multiple of two: $\frac{P_{outer}}{P_{inner}} \bmod 2 = 0$. In the simple case shown in figure~\ref{fig:projections}, we would acquire 4 projections for the central and 8 projections for each of the lateral scans, thus avoiding oversampling the central part of the sample. To be able to merge the projection images, we interpolate 4 projections (dashed) in between the acquired projections (green) prior to stitching. If the amount of projections would not be a multiple of two, stitching the projections of the inner scan with the projections from the outer ones would introduce additional processing steps to interpolate the required intermediate projections.

\subsubsection{Scanning Time Reduction}%
To be able to further reduce the total scanning time, we developed different scanning protocols, which all relate to a gold standard protocol. Such a gold standard scan would cover the desired field of view while fulfilling the sampling theorem in all parts of the field of view, as shown in figure~\ref{fig:Setup3SubScans}a). For this example we would like to achieve a field of view of 3072$\times$3072 pixels. The dark gray circle shown in aforementioned figure is the field of view that can be fully covered, the rest of the slice in light grey would be either missing or show artifacts arising from partial volume effects, depending on the chosen reconstruction algorithm. To cover this desired field of view with a standard scan obtained from a detector with the size of 1024 pixels, nine independent scans would be needed. Acquiring nine independent scans would show exactly the same ratio of coverage vs.\ potentially missing parts, but some of the missing parts would be lying inside the desired field of view (light gray parts of figure~\ref{fig:Setup3SubScans}a) inside the ring covering the desired field of view). Nonetheless, this setup corresponds to the gold standard scan which has been defined as protocol A in table~\ref{tab:protocols}. Figure~\ref{fig:Setup3SubScans}c) shows how the desired field of view can be covered with a wide-field scan obtained from merged projections as described above. No missing parts arising from partial volume effects are lying inside the desired field of view.

To fully satisfy the sampling theorem for a scan with the detector width $D$ we need to acquire an amount of projections $P=D\frac{\pi}{2}$, which leads to the acquisition of totally 14476 projections for the setup shown in figure~\ref{fig:Setup3SubScans}b). For the scan shown in figure~\ref{fig:Setup3SubScans}c) we also need to acquire 14476 projections, since we need to acquire three times $3072\frac{\pi}{2}$ projections if the single projections from each subscan are to be merged into one projections covering the field of view prior to reconstruction.

\ifiucr
	%\onecolumn
	\begin{figure}%
		\centering%
		\caption{Setup; desired field of view and two variants of covering the desired field of view with 9 independent small scans or 3 subscans.}%
		\begin{tabular}{p{0.3\linewidth}p{0.3\linewidth}p{0.3\linewidth}}%
			\input{tikz-images/SubScanSetup/3fov}&%
			\input{tikz-images/SubScanSetup/3gold}&%
			\input{tikz-images/SubScanSetup/3wfs}\\%
			a) field of view to be covered&%
			b) Gold Standard; covering the field of view with 9 independently reconstructed small scans&%
			c) Covering the field of view with merged projections from one central and two half ring scans\\%
		\end{tabular}%
		\label{fig:Setup3SubScans}%
	\end{figure}%
	%\twocolumn
\else
	\begin{figure*}[htp]
		\centering%
		\input{tikz-images/Setup3SubScans}%
		\caption{Setup; desired field of view and two variants of covering the desired field of view with 9 independent small scans or 3 subscans.}%
		\label{fig:Setup3SubScans}%
	\end{figure*}
\fi

The protocols shown for increasing the field of view to three times the detector width can be iterated to bigger field of view. Figures~\ref{fig:Setup5SubScans} and \ref{fig:Setup7SubScans} show the setup if the field of view has to be increased five or seven times, respectively.

\ifiucr
	%\onecolumn
	\begin{figure}%
		\centering%
		\caption{Setup; desired field of view and two variants of covering the desired field of view with 25 independent small scans or 5 subscans.}%
		\begin{tabular}{p{0.3\linewidth}p{0.3\linewidth}p{0.3\linewidth}}%
			\input{tikz-images/SubScanSetup/5fov} &%
			\input{tikz-images/SubScanSetup/5gold} &%
			\input{tikz-images/SubScanSetup/5wfs}\\%
			a) field of view to be covered &%
			b) Gold Standard; covering the field of view with 25 independently reconstructed small scans &%
			c) Covering the field of view with merged projections from one central and four half ring scans \\%
		\end{tabular}%
		\label{fig:Setup5SubScans}%
	\end{figure}%
	%\twocolumn
\else
	\begin{figure*}[htp]
		\centering%
		\input{tikz-images/Setup5SubScans}%
	%	\caption[Setup for 5 SubScans]
		\caption{Setup; desired field of view and two variants of covering the desired field of view with 25 independent small scans or 5 subscans.}%
		\label{fig:Setup5SubScans}%
	\end{figure*}
\fi

\ifiucr
	%\onecolumn
	\begin{figure}%
		\centering%
		\caption{Setup; desired field of view and two variants of covering the desired field of view with 49 independent small scans or 7 subscans.}%
		\begin{tabular}{p{0.3\linewidth}p{0.3\linewidth}p{0.3\linewidth}}%
			\input{tikz-images/SubScanSetup/7fov} &%
			\input{tikz-images/SubScanSetup/7gold} &%
			\input{tikz-images/SubScanSetup/7wfs} \\%
			a) field of view to be covered &%
			b) Gold Standard; covering the field of view with 49 independently reconstructed small scans &%
			c) Covering the field of view with merged projections from one central and six half ring scans \\%
		\end{tabular}%
		\label{fig:Setup7SubScans}%
	\end{figure}%
	%\twocolumn
\else
	\begin{figure*}[htp]
		\centering%
		\input{tikz-images/Setup7SubScans}%
	%	\caption[Setup for 7 SubScans]
		\caption{Setup; desired field of view and two variants of covering the desired field of view with 49 independent small scans or 7 subscans.}%
		\label{fig:Setup7SubScans}%
	\end{figure*}
\fi

\subsection{Wide Field Scanning Setup}%
\label{subsec:wfs-setup}%
A custom MATLAB-script (MATLAB\textsuperscript{\textregistered} 7.6.0.321 (R2008a), The MathWorks, Inc.) which asks for the scanning parameters like desired field of view, detector width, desired overlap between the subscans, magnification and binning has been written. According to these presets, the scripts calculated the necessary projections to fulfill the sampling theorem for the chosen field of view as a gold-standard and computes different acquisition protocols with reduced amount of projections. For all these scanning protocols a reconstruction is simulated using a Shepp-Logan phantom~\cite{Shepp1974} and we calculate the expected reconstruction quality using the difference image for each simulated reconstruction with the gold standard (the original phantom). This expected reconstruction quality is then plotted against the acquisition time, which enables the user to chose a suitable protocol balancing image quality and acquisition time.

After the user has chosen a suitable protocol, a file containing the details of the scan is written to disk. This file contains the parameters like amount of needed subscans, the positions of the sample, number of projections as well as start and stop angles of the rotation for each subscan. A custom Python-script parses the file containing the details and interacts with the EPICS-System (Experimental Physics and Industrial Control System, Argonne National Laboratory, Argonne, USA, \url{http://www.aps.anl.gov/epics/}), which itself is used to control the hardware of the TOMCAT beamline, allowing for an unattended batch scan of all the desired subscans.

After the multiple subscans have been recorded, the stitching of the projections recorded per subscans into projections covering the desired field of view is performed with minimal user interaction using a second MATLAB-script. Further processing of the merged projections like sinogram generation and reconstruction into the tomographic dataset is integrated into the TOMCAT data-processing pipeline, as specified by%
\ifhtml%
	~\citet{Hintermueller2009}%
\else%
	~\citeasnoun{Hintermueller2009}%
\fi%
.

\subsection{Batch Acquisition of the Protocols}%
All subscans of each protocol have been scanned without any user intervention, except input of the sample name at the start of the batch-scan. All parameters such as sample-position in relation to the beam, rotation angles and amount of projections to obtain for each of the subscans have been set in a preference file generated using the aforementioned MATLAB-script. All 19 scanned protocols (B--T) have been scanned as a batch scan, without manual intervention, permitting a direct comparison of the reconstructed slices.

After acquisition of the three subscans per protocol, custom MATLAB functions read the parameters of the single subscans (e.g.\ sample name, amount of subscans, amount of dark and flat images) as well as the desired output-name and -suffix and performs all necessary calculations like loading of the correct projections from each subscan, normalizing, interpolation, cutline detection and correct stitching of the images into wide field projections. Uncorrected projections of three subscans for protocol B are shown in figure~\ref{fig:wide field scan results}a) and b).%

Using the Radon transformation~\cite{Radon1917}, the corrected and merged projections were transformed into so-called sinograms, where the $n$\textsuperscript{th} is composed of the $n$\textsuperscript{th} line of every corrected projection. One sinogram thus contains as many rows as the number of obtained projections (angular steps) and as many columns as the width of the merged projection images, covering the increased field of view. Each sinogram corresponds to one slice of the tomographic dataset. The $n$\textsuperscript{th} slice of the tomographic scan was reconstructed from the $n$\textsuperscript{th} sinogram using an FFT-based gridrec~\cite{Dowd1999} algorithm.

The merged projections were reconstructed on a 20-node server farm (five \SI{64}{\bit} Opteron machines with 4 cores and \SI{8}{\giga\byte} RAM each). The reconstructions result in an image stack covering a large sample volume of 2793$\times$2793$\times$1024 pixels, an approximately nine-fold increase from the standard volume of 1024$\times$1024$\times$1024 pixels for one single scan. One slice of the resulting dataset for protocol B is shown in figure~\ref{fig:wide field scan results}c).