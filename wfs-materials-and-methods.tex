%!TEX root = widefieldscan.tex
\svnidlong
{$HeadURL$}
{$LastChangedDate$}
{$LastChangedRevision$}
{$LastChangedBy$}
\framebox{Author: \svnauthor|Rev: \svnrev|Last change: \svndate}% - URL: \url{\svnkw{HeadURL}}}
\section{Materials and Methods}
\label{sec:materials and methods}
\subsection{Animal Handling and Tissue Preparation}
The preparation of the lung samples has been performed according to~\citet{Schittny1997,Schittny1998}. Briefly, the lungs have been extracted from Sprague-Dawley rats after they have been perfused and filled with phosphate buffered saline by instillation via tracheostomy until the midrespiratory lung volume was reached.

The extracted lung lobes have been fixed for potential storage in 2.5\% glutaraldehyde (C$_5$H$_8$O$_2$). For the preparation of the imaging the samples have been postfixed --- as in electron microscopy --- with 1\% osmium tetroxide (OsO$_4$) and stained with 4\% uranyl acetate (C$_4$H$_6$O$_6$U), dehydrated in a graded series of ethanol and transferred into paraffin.\todo{Citation needed! Or longer explanation} Osmium tetroxide and uranyl acetate exhibit a higher absorption contrast for x-rays than the unstained lung tissue, thus facilitating the imaging of the stained tissue. The lung samples have been mounted onto standard electron microscopy sample mounts with a diameter of approximately \unit{13}{\milli\meter} (PLANO GmbH, Wetzlar, Germany) using paraffin.

Handling of the animals before and during the experiments, as well as the experiments themselves, were approved and supervised by the Swiss Agency for the Environment, Forests and Landscape and the Veterinary Service of the Canton of Bern.

\subsection{SRXTM}
The experiments were performed on the TOMCAT beamline at the Swiss Light Source, Paul Scherrer Institut, Villigen, Switzerland. TOMCAT is one of thirteen operating beam lines at the SLS.\todo{13 beamlines, still true?} It is located at the port X02DA of the SLS. The beamline receives photons from a \unit{2.9}{\tesla} super-bending magnet. The critical energy of this super-bending magnet is \unit{11.1}{\kilo\electronvolt} (corresponding to a wavelength of \unit{0.122}{\nano\meter}). Detailed technical specifications of the beamline and beam characteristics have been described by~\citet{Stampanoni2006a,Stampanoni2007}.

\subsubsection{Image Acquisition}
The sample holder at TOMCAT is equipped with an appropriate collet chuck to mount the standard EM sample tables into the beam. The samples were scanned at an x-ray energy of \unit{12.6}{\kilo\electronvolt}. After penetration of the sample, the x-rays are converted into visible light by a Ce-doped YAG scintillator (Crismatec Saint-Gobain, Nemours, France\todo{Crismatec still true?}). These projection images were further magnified by diffraction limited microscope optics and digitized by a high-resolution \numprint{2048}$\times$\numprint{2048} pixel CCD camera. All samples were imaged using 10$\times$ magnification, with 2$\times$2 binning and \unit{125}{\milli\second} exposure time or no binning and \unit{500}{\milli\second} exposure time, resulting in isotropic voxels of a side length of \unit{1.4}{\micro\meter} or of \unit{0.70}{\micro\meter}\todo{correct voxel side length?}, respectively.

As mentioned in section~\ref{subsec:enhancing the field of view}, to obtain an enhanced FOV, we need to scan the samples with multiple subscans at varying positions covering the whole sample. To achieve this, we have written a custom MATLAB\textregistered-script\todo{Script(s) in Appendix?} (MATLAB 7.6.0.321 (R2008a), The MathWorks, Inc.), where the user is able to input the scanning parameters like desired FOV, detector width, desired overlap between the subscans, magnification and binning. According to these parameters, MATLAB has written a preference file to the disk, which has been parsed by a custom Python-script that was used for the interaction with the EPIC-System (Experimental Physics and Industrial Control System, \url{http://www.aps.anl.gov/epics/}), which is controlling the TOMCAT beamline. The sample on the sample holder was not touched during the acquisition of the different subscans. All parameters like filename, sample-position in relation to the beam, rotation angles and amount of projections to obtain for the subscans have been set beforehand by the MATLAB-script, read out by the Python-script so that all the scans could be performed as a batch job without manual intervention.

\subsection{Image Processing}
\label{subsec:image processing}
After the acquisition of the sub-scan projection images, these image sets are corrected with the so called dark field and flat field images, as seen in figure~\ref{subfig:flat}. The dark field images are obtained while all the shutters are closed --- thus no x-rays are present --- and are used for the detection of camera noise and dark current. The flat field images (FI) are obtained with x-ray beam, but without the sample (see figure~\ref{subfig:flat}). They are recorded to remove the varying beam profile brightness from the projection images. The projections (PI) are first baseline corrected, then the average of the dark images is subtracted and afterwards they are normalized into corrected projections (CPR) as seen in equation~\ref{eq:correction}
\begin{equation}
\text{CPR}=-ln\left(\frac{\text{PI}}{\text{FI}}\right)=ln(\text{FI})-ln(\text{PI})
\label{eq:correction}
\end{equation}

\subsubsection{Stitching}
Generally, tomographic images are obtained for 

\begin{figure}[tb]
	\centering
	\begin{tikzpicture}
		%drawing grid
		%\draw[color=gray] (0,0) grid (8,1);
		%camera
		\draw (-.2,-.2) rectangle (1.2,1.2);
		\draw (.5,-.25) node [below] {camera};
		% beam
		\draw[<-] (1.2,0) -- (8,0);
		\draw[<-] (1.2,1) -- (8,1);
		\draw (2.5,1.25) node [above] {beam};
		\draw (6.5,1.25) node [above] {beam};
		%sample
		\draw (4.5,0.5) circle (.5);
		\draw (4.5,-.25) node [below] {sample};
		%sample rotation
		\draw[->] (4.5,0.25) arc (-90:90:.25);
	\end{tikzpicture}
	\caption{Covering the FOV -- one scan}
	\label{fig:covering}
\end{figure}

\begin{figure}[tb]
	\centering
	\begin{tikzpicture}
		%drawing grid
		% \draw[color=gray] (0,0) grid (8,1);
		%camera
		\draw (-.2,-.2) rectangle (1.2,1.2);
		\draw (.5,-.25) node [below] {camera};
		%position 1
			% beam
			\draw[<-] (1.2,0) -- (10,0);
			\draw[<-] (1.2,1) -- (10,1);
			%sample
			\draw (3,0.5) circle (.5);
			\draw (3,0.5) circle (1.5);
			\draw (3,-1.5) node {pos 1};
			% movement
			%\draw[->]  (3,1.25) -- (3,1.75);
			%\draw[->]  (3,-.25) -- (3,-.75);
			%sample rotation
			\draw[->] (3,0.25) arc (-90:90:.25);
		%position 2
			% sample
			\draw (6,1.5) circle (.5);
			\draw (6,1.5) circle (1.5);
			\draw (6,-1.5) node {pos 2};
			% movement
			\draw[->]  (6,.25) -- (6,.75);
			%sample rotation
			\draw[->] (6,1.25) arc (-90:90:.25);
		% position 3
			% sample	
			\draw (9,-.5) circle (.5);
			\draw (9,-.5) circle (1.5);
			\draw (9,-1.5) node {pos 3};
			% movement
			\draw[<-]  (9,.25) -- (9,.75);
			%sample rotation
			\draw[->] (9,-.75) arc (-90:90:.25);
		% beam
			\draw[<-] (1.2,0) -- (8,0);
			\draw[<-] (1.2,1) -- (8,1);
				% labels
		%\draw (2.5,1.25) node [above] {beam};
		%\draw (6.5,1.25) node [above] {beam};
		%\draw (4.5,-1) node [below] {sample};
	\end{tikzpicture}
	\caption{Covering the FOV -- three scans $\rightarrow$ sample has to move, explain that we still only do \unit{180}{\degree} scans!}
	\label{fig:covering}
\end{figure}

To achieve a tomographic image for each sample, a varying amount of projections were obtained over a sample rotation of \unit{180}{\degree}.




To cover the desired FOV, the projection images have to be obtained in such a manner that they overlap each other slightly. This overlap is necessary for the compensation of variations in the imaging process and correct stitching of the single projections into one big projection image. 

After correction, the projections of the single overlapping subscans are merged into one projection which covers the full FOV chosen by the user (see figure~\ref{subfig:mrg}). To achieve a correct stitching of the sub-scan projections, the cutting line to remove the overlap is calculated using the mutual difference between adjacent subscans\todo{Xris: Documentation of notch-method?}.

Since the amount of obtained projection varies for different positions of the sample in relation to the camera window --- at outer positions we record more projections compared to central positions --- different amounts of projections have been obtained for each subscan. If $N_x$ is the total amount of projections for each subscan we cannot simply stitch together all the images from 1 to $N$ for each subscan $x$, or we will end up with wrong merged projections. Instead, we have to stitch them together in such a way that we 



iwe also have to interpolate projection images prior to stitching. All this has been achieved using a custom MATLAB\textsuperscript{\textregistered} script which incorporates the loading, normalizing, interpolation and correct stitching of the images into wide field projections as seem in the aforementioned figure.

After the merging of the normalized projections, the merged projections were reconstructed into the virtual tomography slices using a standard filtered backprojection algorithm or a FFT-based gridrec algorithm~\cite{Dowd2003} on a 20-node server farm (Pentium 4, 2.8 GHz processor, 512 MB RAM\todo{cluster node specs?}). This reconstruction results in an image stack of \numprint{1024} or \numprint {2048} image slices in tif-format, depending on the binnig chosen at recording time. The size of the images recorded for this publication varies from \numprint{2996}$\times$\numprint{2996} pixels up to \numprint{9703}$\times$\numprint{9703} pixels\todo{9703 px not really reconstructed up to now\ldots}.