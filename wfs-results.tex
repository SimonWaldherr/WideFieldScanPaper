%!TEX root = widefieldscan.tex
\svnidlong
{$HeadURL$}
{$LastChangedDate$}
{$LastChangedRevision$}
{$LastChangedBy$}

\begin{center}
	\fbox{
		\begin{minipage}{.618\columnwidth}
		The section below is versioned at \url{\svnkw{HeadURL}} (last commit @ \svnfileday.\svnfilemonth.\svnfileyear \space \svnfilehour:\svnfileminute \space (UTC\svnfiletimezone), Revision: \svnkw{LastChangedRevision}).
		\end{minipage}
	} 
\end{center}

\section{Results}
\label{sec:Results}
\subsection{Image Merging and Reconstruction}
\label{sec:Image Merging and Reconstruction}
Results of the steps mentioned in section~\ref{sec:materials and methods} are shown in figure~\ref{fig:wide field scan results}. Figure~\ref{fig:subscans} shows exemplary projection images from overlapping subscans prior to correction and normalization. Figure~\ref{fig:merge-proj} shows a merged projection image prior to reconstruction and figure~\ref{fig:merge-rec} shows the end-result of such a wide field scan, a reconstructed slice of the whole sample with a FOV of \SI{2994}{pixels} (\SI{4.19}{\milli\meter}) which is approximately three times the size of what can be achieved with one single binned scan (\SI{1024}{pixels} or \SI{1.43}{\milli\meter}).

\begin{figure*}
	\renewcommand{\imsize}{.16\linewidth}
	\pgfmathsetlength{\imagewidth}{\imsize} % desired display width of image
	\pgfmathsetlength{\imagescale}{\imagewidth/512} % pixel width of image
	\centering
		\subfloat[Uncorrected projection images from subscans s$_1$--s$_3$, each with a size of 1024$\times$1024 pixels at a resolution of \SI{1.4}{\micro\meter\per pixel}, covering a FOV of approximately \SI{0.7}{\milli\meter}. The scans overlap each other by approximately 100 pixels. 4676 projections have been acquired for the subscans s$_1$ and s$_3$, 1169 projections have been acquired for subscan s$_2$, all over a rotation of \SI{180}{\degree}.]{%
			\label{fig:s1}%
			\includegraphics[width=\imsize]{img/merge/R108C10B-s1}%
			\includegraphics[width=\imsize]{img/merge/R108C10B-s2}%
			\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
				% place image (integer coordinates refer to pixel centers):
				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
					{\includegraphics[width=\imagewidth]{img/merge/R108C10B-s3}};
				\draw[|-|,color=white] (256-64,450) -- (512-64,450) node[midway,above] {\SI{700}{\micro\meter}};
			\end{tikzpicture}
			\label{fig:subscans}
			}
		\renewcommand{\imsize}{.48\linewidth}
		\pgfmathsetlength{\imagewidth}{\imsize} % desired displayed width of image
		\pgfmathsetlength{\imagescale}{\imagewidth/1498} % pixel width of image
		\subfloat[Merged and corrected image from the three subscans shown in subfigure~\subref{fig:subscans}. The merged projections have a size of 2994$\times$1024 pixels at a resolution of \SI{1.4}{\micro\meter\per pixel}. The Subscans s$_1$--s$_3$ overlap each other by approximately 150 pixels, thus the width of the merged projection is smaller than three times the width of the subscans. The projections of the subscans above have been merged into 4676 projections images like the one shown here and were then reconstructed into a tomographic dataset using a filtered back-projection reconstruction algorithm.]{%
			\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
					{\includegraphics[width=\imagewidth]{img/merge/R108C10B-merge}};
				\draw[|-|,color=white] (1242-64,450) -- (1498-64,450) node[midway,above] {\SI{700}{\micro\meter}};
			\end{tikzpicture}
			\label{fig:merge-proj}
			}
		\renewcommand{\imsize}{\linewidth}
		\pgfmathsetlength{\imagewidth}{\imsize} % desired displayed width of image
		\pgfmathsetlength{\imagescale}{\imagewidth/1365} % pixel width of image (image has been resized from 2994*1123, so that scalebar is at the same height without calculating too much...)
		\subfloat[Cropped part of one slice of the tomographic dataset reconstructed from the merged projections, where one is shown in subfigure~\subref{fig:merge-proj}. The halo directly around the lung tissue arises from the paraffin where the sample is embedded in. The bright circular shape inscribed in the square arises from the filtered back-projection, the chosen reconstruction method. The size of the cropped image is 2994$\times$1123 pixels. The small inset on the upper left corner shows an overview over the full slice with a size of 2994$\times$2994 pixels.]{%
			\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
				% place image (integer coordinates refer to pixel centers):
				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
					{\includegraphics[width=\imagewidth]{img/merge/R108C10B-merge1016-crop}};
				\newcommand{\size}{.2\imagewidth}
				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
					{\includegraphics[width=\size]{img/merge/R108C10B-merge1016}};
					\draw[white] (\size,0) -- (\size,-\size) -- (0,-\size);
				\draw[|-|,color=white] (1109-64,450) -- (1365-64,450) node[midway,above] {\SI{700}{\micro\meter}};
			\end{tikzpicture}
			\label{fig:merge-rec}
			}
	\caption{Different stages of a wide field scan of a rat lung sample obtained from a Sprague-Dawley rat 10 days after birth, showing the distal-medial edge of the right lower lung lobe. The sample has been scanned at a beam energy of \SI{12.6}{\kilo\electronvolt}.}
	\label{fig:wide field scan results}	
\end{figure*}

\subsection{Quality guided protocol selection}
A sequence of 19 protocols with varying quality has been scanned to assess the simulations. The properties of the scan have been chosen according to a MATLAB-plot---as described in section~\ref{seq:Image Acquisition}---which has been generated with \verb+MATLAB\wfs-sim\main.m+ \todo{do we provide the code for reproducible research? or is it ``closed source''?} for a protocol with the diameter of \SI{3.8}{mm} and three overlapping subscans.

We assessed the image differences for the 19 scanned protocols in such a way that the tiff slices have been binarized using an automated thresholding algorithm method, which chooses the threshold to minimize the intraclass variance of the black and white pixels~\cite{Otsu1979}. The binarization of the images suppresses small variations in the gray values which can occur through the reconstruction for the different protocols. A suitable threshold has been automatically chosen by the thresholding algorithm.

The thresholded slices of each protocol ($Slice_{Prot_{i}}$ have been compared to the gold standard protocol ($Slice_{B_{i}}$) in such a way that the sum of all pixels of the absolute difference image ($D_{Prot_{i}}$) of the relevant protocol with the gold standard protocol has been taken and this difference image has been summed up to yield an error value ($E_{Prot_{norm_{i}}}$). Equations~\ref{eq:errorcalculation-a}--\ref{eq:errorcalculation-b} show the details of this calculations.

\begin{eqnarray}
    D_{Prot_{i}} &=& |Slice_{B_{i}}-Slice_{Prot_{i}}| \label{eq:errorcalculation-a}\\
E_{Prot_{norm_{i}}} &=& \sum_{x}\sum_{y} D_{Prot_{i}} \label{eq:errorcalculation-b}\\
    E_{Prot_{norm}} &=& \overline{E_{Prot_{norm_{i}}}} \pm \sigma(E_{Prot_{norm_{i}}}) \mbox{for} i=1:5:1024 \label{eq:errorcalculation-c}
\end{eqnarray}

The error value ($E_{Prot_{norm}}$) has been calculated for 205 regularly spaced slices of the full dataset (1024 slices). The mean ($\overline{E_{Prot_{norm_{i}}}}$) and standard deviation of the error have been plotted (see figure~\ref{fig:NormalizedErrorPlot}) in such a way that the error has been scaled to arbitrary units from 0 to 1.

We see that---as expected---the normalized error grows with decreasing amount of total obtained projections. The simulated scanning quality shown in figure~\ref{fig:2008c-qualityplot} shows the simulated quality to expect from the scan, while figure~\ref{fig:NormalizedErrorPlot} is a plot of the calculated error of the different protocols compared to protocol A, hence the outcome of the experiments using not a simulated phantom, but actual scans of lung tissue.

For protocols with the same total amount of projections, but different configurations of amount of projections for the central and the ring scan (e.g.\ Protocols C and D aswell as procotocls M and N) we see a difference in the error. This difference arises through the fact that the differing amount of subscans acquired for the central and the subscan add up to the same total amount of projections, but contribute differently to the quality of the reconstruction. The details for tose protocols are described in table~\ref{tab:detailsCDMN}. Since the central portions of the sample and the ring portions of the sample cover differently sized areas of the sample, we have expected a different error-value for inbetween those protocols. 

\begin{figure*}
	\centering
		\input{tikz-images/plots/2008c-MeanNormalizedErrorPlot}
	\caption{Plot of normalized Error ($E_{norm}$ for the 19 scanned protocols. The normalized Error has been calculated in such a way that we calculated the difference image for Protocol 'x' compared to Protocol 'A',  and . The error bars for each protocol show the standard deviation of the error which was calculated for 205 of the 1024 slices for each protocol. Note that the error is plotted inversely, so the axes of this plot and the plot in figure~\ref{fig:2008c-qualityplot} are directly comparable.}
	\label{fig:NormalizedErrorPlot}
\end{figure*}

\begin{table*}%
	\centering
	\caption{Details of amount of projections for protocols C vs.\ D and M vs.\ N}
	\begin{tabular}{rcccc}
		\toprule
							& C 	& D 	& M 	& N \\
		\midrule
		Central scan		& 2622 	& 4370	& 1311 	& 2185 \\
		Ring scan	 		& 5244 	& 4370  & 2622 	& 2185 \\
		\midrule
		total Projections	& 13110	& 13110	& 6555	& 6555 \\
		\bottomrule
	\end{tabular}  
	\label{tab:detailsCDMN}
\end{table*}

Figure~\ref{fig:NormalizedErrorPlot} confirms this finding. For a comparable total amount of recorded projections, the quality of the dataset with reduced projections is lower than when an equal amount of projections has been recorded for all thre subscans\todo{compare O/P, M/N, I/J, E/H, C/D}.

\subsection{Three dimensional visualizations}
\subsubsection{19 Protocols}
The 19 different protocols which have been obtained from the same sample have been three dimensionally visualized and analyzed using MeVisLab (Version 1.6.1 (2008-09-21 Release), MeVis Medical Solutions AG, Bremen, Germany).
Using a visualization network \todo{do we need to exactly explain the network? or can we give it in supplem. mat.?} we automatically segmented airway segments from the dataset using a region growing algorithm~\cite{wiki:regiongrowing} using the same seed point to extract segments for all protocols.

Two exemplary visualizations of such segment extractions are shown in figure~\ref{fig:BvsT}\todo{explain these extractions in more details}.

\begin{figure*}
	\centering
	\renewcommand{\imsize}{.5\linewidth}	
		\subfloat[Overview Protocol B]{%
			\includegraphics[width=\imsize]{img/protocols/BvsT/overviewB}}
		\subfloat[Overview Protocol T]{%
			\includegraphics[width=\imsize]{img/protocols/BvsT/overviewT}}\\
	\renewcommand{\imsize}{.495\linewidth}
		\subfloat[Detailed view of segments of Protocol B]{%
			\includegraphics[width=\imsize]{img/protocols/BvsT/detail-1-B}}\hfill
		\subfloat[Detailed view of segments of Protocol B]{%
			\includegraphics[width=\imsize]{img/protocols/BvsT/detail-1-T}}\\
		\subfloat[Bottom view of underside of Protocol B]{%
			\includegraphics[width=\imsize]{img/protocols/BvsT/detail-2-B}}\hfill
		\subfloat[Bottom view of underside of Protocol T]{%
			\includegraphics[width=\imsize]{img/protocols/BvsT/detail-2-T}}
	\caption{Segmentation of two exemplary protocols, namely B and T.}
	\label{fig:BvsT}
	\todo[inline]{this figure doesn't help at all. yet.}
\end{figure*}

\subsubsection{some other visualizations}
\todo{Enhancement of FOV from $s_{2}$ to wfs}
\renewcommand{\imsize}{.5\linewidth}
\pgfmathsetlength{\imagewidth}{\imsize} % desired displayed width of image
\pgfmathsetlength{\imagescale}{\imagewidth/1202} % pixel width of imagefile used below
\begin{figure*}
	\centering
		\subfloat[conventional scan]{%
			\label{subfig:overview-s2}%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]%
				\def\x{225}%
				\def\y{625}%
    				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)%
	    			{\includegraphics[width=\imagewidth]{img/widefieldscanning/R108C04C-overview-s2}};%
					\draw[|-|,thick] (229,428) -- (659,586) node [right] {\SI{1.4336}{\milli\meter}};%
%				    % 458 px = 1.4336 mm > 100 px = 313 um > 160 px = 500 um
				    \draw[|-|,thick] (\x,\y) -- (160+\x,\y) node [midway,above] {\SI{500}{\micro\meter}};%
				\end{tikzpicture}%
		}%
		\subfloat[wide field scan]{%
			\label{subfig:overview-merge}%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]%
				\def\x{200}%
				\def\y{625}%
    				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)%
	    			{\includegraphics[width=\imagewidth]{img/widefieldscanning/R108C04C-overview-merge}};%
					\draw[|-|,thick] (40,456) -- (890,610) node [right] {\SI{3.8444}{\milli\meter}};%
				    % 864 px = 3.8444 mm > 100 px = 445 um > 112 px = 500 um
					\draw[|-|,thick] (\x,\y) -- (224+\x,\y) node [midway,above] {\SI{1}{\milli\meter}};%
				\end{tikzpicture}%
		}%
		\caption{Three dimensional visualization of the distal-medial edge of the right lower lung lobe of a Sprague Dawley rat. The grey structure in the background shows a semitransparent view of the sample with segmented airways. The foreground shows isosurfaces of terminal airways that have been extracted using a region growing algorithm (green and red for \subref{subfig:overview-s2}, green and red yellow for \subref{subfig:overview-merge}.}%
	\label{fig:overview}%
\end{figure*}

\renewcommand{\imsize}{.5\linewidth}
\pgfmathsetlength{\imagewidth}{\imsize} % desired displayed width of image
\pgfmathsetlength{\imagescale}{\imagewidth/1299} % pixel width of imagefile used below
\begin{figure*}
	\centering
		\subfloat[conventional scan]{%
			\label{subfig:down-s2}%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]%
				\def\x{750}%
				\def\y{725}%
    				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)%
    				{\includegraphics[width=\imagewidth]{img/widefieldscanning/R108C04C-down-s2}};%
				\draw[|-|,thick] (350,290) -- (350,595) node [left] {\SI{1.4336}{\milli\meter}};%
			   	 % 305 px = 1.4336 mm > 100 px = 470 um > 106 px = 500um
					\draw[|-|,thick] (\x,\y) -- (106+\x,+\y) node [midway,above] {\SI{500}{\micro\meter}};%
				\end{tikzpicture}%
		}%\\%
		\subfloat[wide field scan]{%
			\label{subfig:down-merge}%%
				\begin{tikzpicture}[x=\imagescale,y=-\imagescale]%
				\def\x{775}%
				\def\y{825}%
    				\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)%
    				{\includegraphics[width=\imagewidth]{img/widefieldscanning/R108C04C-down-merge}};%
			    	\draw[|-|,thick] (547,19) -- (498,775) node [left] {\SI{3.8444}{\milli\meter}};%
				    % 758 px = 3.844 mm > 100 px = 507 um > 99 px = 500um
					\draw[|-|,thick] (\x,\y) -- (198+\x,\y) node [midway,above] {\SI{1}{\milli\meter}};%
				\end{tikzpicture}%
		}%
	\caption{Three dimensional visualization of the distal-medial edge of the right lower lung lobe of a Sprague Dawley rat (same as in figure~\ref{fig:overview}). View from the underside of the sample}
	\label{fig:down}
\end{figure*}

\subsubsection{5 instead of 3 subscans}
As a proof of concept we have extended the FOV from three to five subscans. We have been able to reconstruct a sample with size of approximately 0.4$\times$3.4$\times$\SI{0.7}{\milli\meter} at a voxel side length of \SI{0.7}{\micro\meter}. A visualization of such a lung tissue slab is shown in figure~\ref{fig:LungSlabSophie}.

\begin{figure*}
	\renewcommand{\imsize}{\textwidth}
	\pgfmathsetlength{\imagewidth}{\imsize} 		 % desired displayed width of image
	\pgfmathsetlength{\imagescale}{\imagewidth/1589} % 1589*728 = width of imagefile used below
	\newcommand{\startx}{982} %= 1589*.618
	\newcommand{\starty}{655} %= 728*.9
	\centering
	\subfloat[]{
		\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
 			\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
 			{\includegraphics[width=\imagewidth]{img/sophie/full}};
 			\draw[|-|](\startx-808,\starty) -- (\startx+500,\starty) node[midway,above] {\SI{3.3978}{\milli\meter}}; % 4854px * 0.7 um/px = 3.3978 mm
	 	\end{tikzpicture}
	 	\label{subfig:LungSlab}
		}
	\renewcommand{\imsize}{.25\linewidth}
	\pgfmathsetlength{\imagewidth}{\imsize} % desired displayed width of image
	\pgfmathsetlength{\imagescale}{\imagewidth/902} % 1543*928 = width of imagefile used below
	\renewcommand{\startx}{557} %= 902*.618
	\renewcommand{\starty}{802} %= 891*.9
	\subfloat[]{%
		\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
			\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
 			{\includegraphics[width=\imagewidth]{img/sophie/crop-green-background}};
 			\draw[|-|] (\startx+0,\starty) -- (\startx+200,\starty) node[midway,above] {\SI{179.2}{\micro\meter}}; % cube with 256 px = 179.2 um
	 	\end{tikzpicture}%
	 	\label{subfig:LungSlabDetailsGreenBG}%
		}
	\subfloat[]{%
		\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
			\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
 			{\includegraphics[width=\imagewidth]{img/sophie/crop-green}};
 			\draw[|-|] (\startx+0,\starty) -- (\startx+200,\starty) node[midway,above] {\SI{179.2}{\micro\meter}}; % cube with 256 px = 179.2 um
	 	\end{tikzpicture}%
	 	\label{subfig:LungSlabDetailsGreen}%
		}%
	\subfloat[]{%
		\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
			\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
 			{\includegraphics[width=\imagewidth]{img/sophie/crop-red}};
 			\draw[|-|] (\startx+0,\starty) -- (\startx+200,\starty) node[midway,above] {\SI{179.2}{\micro\meter}}; % cube with 256 px = 179.2 um
	 	\end{tikzpicture}%
	 	\label{subfig:LungSlabDetailsRed}%
		}
	\subfloat[]{%
		\begin{tikzpicture}[x=\imagescale,y=-\imagescale]
			\node[anchor=north west,inner sep=0pt,outer sep=0pt] at (0,0)
 			{\includegraphics[width=\imagewidth]{img/sophie/crop-red-background}};
 			\draw[|-|] (\startx+0,\starty) -- (\startx+200,\starty) node[midway,above] {\SI{179.2}{\micro\meter}}; % cube with 256 px = 179.2 um
	 	\end{tikzpicture}%
	 	\label{subfig:LungSlabDetailsRedBG}%
		}
	\caption{Visualization of lung tissue slab: %
		\subref{subfig:LungSlab}: Three dimensional volume rendering of slab of lung tissue with a size of 554$\times$4854$\times$1024 pixels at a voxel side length of \SI{0.7}{\micro\meter}. Both inset cubes have a side length of 256 pixels and were automatically segmented using a region growing algorithm. 
 		\subref{subfig:LungSlabDetailsGreenBG}: Close-up of inset cube at an outer position in the sample, including the background tissue. % 
 		\subref{subfig:LungSlabDetailsGreen}: Close-up of inset cube at an outer position in the sample. Albeit we have been able to automatically segment the lung tissue, segmentation artifacts are visible. Single alveoli can be distinguished. %
 		\subref{subfig:LungSlabDetailsRed}: Close-up of inset cube at a central position in the sample. Single alveoli are clearly visible. %
 		\subref{subfig:LungSlabDetailsRedBG}: Close-up of inset cube at a central position in the sample, including the background tissue. %
		The scale bars are only approximate, since it is a three-dimensional view. The top scale bar is valid for the longest length of the gray lung structure, the bottom scale bar is valid for the width of the red cube.%
	}
	\label{fig:LungSlabSophie}
	\todo[inline]{adapt the scale bars to the final size of the images}
\end{figure*}s